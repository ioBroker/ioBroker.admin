<html>
<head>
    <title>Easy Admin</title>
    <link class="favicon" href="favicon.ico" type="image/x-icon" rel="icon" />
    <link class="favicon" href="favicon.ico" type="image/x-icon" rel="shortcut icon" />
    <link class="favicon" href="favicon.ico" type="image/x-icon" />

    <link rel="stylesheet" type="text/css" href="lib/css/themes/jquery-ui/redmond/jquery-ui.min.css"/>
    <link rel="stylesheet" type="text/css" href="lib/css/themes/jquery-ui/redmond/jquery-ui.structure.min.css"/>
    <link rel="stylesheet" type="text/css" href="lib/css/themes/jquery-ui/redmond/jquery-ui.theme.min.css"/>
    <link rel="stylesheet" type="text/css" href="lib/css/materialize.css">

    <script type="text/javascript" src="lib/js/jquery-3.2.1.min.js"></script>
    <script type="text/javascript" src="lib/js/materialize.js"></script>

    <style>
        #intro-template {
            display: none;
        }

        @media only screen and (min-width: 1601px) {
            .m .row.tab-intro-cards .col.xxl2 {
                width: 20%
            }
        }

        @media only screen and (min-width: 1901px) {
            .m .row.tab-intro-cards .col.xxxl1 {
                width: 15%
            }
        }

        #tab-intro .tab-intro-cards {
            margin-bottom: 0;
            height: calc(100% - 10px);
            overflow: auto
        }

        #tab-intro .tab-intro-cards .info {
            display: none
        }

        #tab-intro .tab-intro-cards .tile .card {
            min-height: 235px;
            cursor: pointer;
        }

        #tab-intro .tab-intro-cards .tile .card-content {
            height: 170px;
            padding: 1rem;
            overflow: hidden;
            text-overflow: ellipsis
        }

        #tab-intro .tab-intro-cards .tile .card-content .card-titles {
            display: block;
            line-height: 32px;
            margin-bottom: 8px;
            font-size: 24px;
            font-weight: 300
        }

        #tab-intro .tab-intro-cards .tile .card-action {
            min-height: 49px
        }

        #tab-intro .tab-intro-cards .tile .card-image {
            background: #e2e2e2;
            max-width: 30%
        }

        #tab-intro .tab-intro-cards .tile .card-image img {
            width: 120px;
            height: auto;
            padding: 2rem .5rem
        }

        #tab-intro .tab-intro-cards .tile .dl-horizontal dd, #tab-intro .tab-intro-cards .tile .dl-horizontal dt {
            width: 50%
        }

        #tab-intro .tab-intro-cards .tile.card-system-info {
            cursor: inherit
        }

        #tab-intro .tab-intro-cards .tile.card-system-info .info {
            display: block;
            position: absolute;
            right: 10px;
            bottom: 10px;
            cursor: pointer;
            z-index: 1
        }

        #tab-intro .tab-intro-cards .tile.card-system-info .info i {
            line-height: 1.2
        }

        #tab-intro .tab-intro-cards .tile.card-system-info .card-image {
            background: #e2e2e2;
            max-width: 30%
        }

        #tab-intro .tab-intro-cards .tile.card-system-info .card-image img {
            height: auto;
            padding: 2rem .5rem
        }

        #tab-intro .tab-intro-cards .tile.card-system-info .card-content {
            height: 220px;
            padding-right: 0
        }

        #tab-intro .tab-intro-cards .tile.card-system-info .card-content .card-content-text {
            padding-right: 5px;
            height: 140px
        }

        #tab-intro .tab-intro-cards .tile.card-system-info .card-content .card-content-text ul {
            margin: 0
        }

        #tab-intro .tab-intro-cards .tile.card-system-info .card-reveal {
            overflow-y: hidden;
            padding-top: 15px
        }

        #tab-intro .tab-intro-cards .tile.card-system-info .card-reveal h5 {
            margin: 0
        }

        #tab-intro .tab-intro-cards .tile.card-system-info .card-reveal .card-title {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 25px
        }

        #tab-intro .tab-intro-cards .tile.card-system-info .card-reveal .card-title i:hover {
            color: red
        }

        #tab-intro .tab-intro-cards .tile.card-system-info .card-reveal a:hover {
            color: #00f
        }

        #tab-intro .tab-intro-cards .tile.card-system-info .card-reveal a {
            position: absolute;
            top: 10px;
            right: 50px;
            color: #000;
            cursor: pointer
        }

        #tab-intro .tab-intro-cards .tile.card-system-info .card-reveal:hover {
            overflow-y: scroll;
            padding-right: 18px
        }

        #tab-intro .tab-intro-cards .tile.card-system-info .card-action {
            display: none
        }

        #tab-intro .tab-intro-cards .tile.card-system-info .system-warning {
            color: red;
            font-weight: 700
        }

        #tab-intro .tab-intro-cards .btn-card-enabled {
            position: absolute;
            top: 1rem;
            right: 1rem;
            display: none
        }

        #tab-intro .tab-intro-cards .card-disabled {
            display: none;
            opacity: .7
        }

        #tab-intro .tab-intro-cards .tile .card {
            min-height: 235px
        }

        #tab-intro .tab-intro-cards .tile .card-content {
            height: 170px;
            padding: 1rem;
            overflow: hidden;
            text-overflow: ellipsis
        }

        #tab-intro .tab-intro-cards .tile .card-content .card-titles {
            display: block;
            line-height: 32px;
            margin-bottom: 8px;
            font-size: 24px;
            font-weight: 300
        }

        #tab-intro .tab-intro-cards .tile .card-action {
            min-height: 49px
        }

        #tab-intro .tab-intro-cards .tile .card-image {
            background: #e2e2e2;
            max-width: 30%
        }

        #tab-intro .tab-intro-cards .tile .card-image img {
            width: 120px;
            height: auto;
            padding: 2rem .5rem
        }

        #tab-intro .tab-intro-cards .tile .dl-horizontal dd, #tab-intro .tab-intro-cards .tile .dl-horizontal dt {
            width: 50%
        }

        #tab-intro .tab-intro-cards .tile.card-system-info {
            cursor: inherit
        }

        #tab-intro .tab-intro-cards .tile.card-system-info .info {
            display: block;
            position: absolute;
            right: 10px;
            bottom: 10px;
            cursor: pointer;
            z-index: 1
        }

        #tab-intro .tab-intro-cards .tile.card-system-info .info i {
            line-height: 1.2
        }

        #tab-intro .tab-intro-cards .tile.card-system-info .card-image {
            background: #e2e2e2;
            max-width: 30%
        }

        #tab-intro .tab-intro-cards .tile.card-system-info .card-image img {
            height: auto;
            padding: 2rem .5rem
        }

        #tab-intro .tab-intro-cards .tile.card-system-info .card-content {
            height: 220px;
            padding-right: 0
        }

        #tab-intro .tab-intro-cards .tile.card-system-info .card-content .card-content-text {
            padding-right: 5px;
            height: 140px
        }

        #tab-intro .tab-intro-cards .tile.card-system-info .card-content .card-content-text ul {
            margin: 0
        }

        #tab-intro .tab-intro-cards .tile.card-system-info .card-reveal {
            overflow-y: hidden;
            padding-top: 15px
        }

        #tab-intro .tab-intro-cards .tile.card-system-info .card-reveal h5 {
            margin: 0
        }

        #tab-intro .tab-intro-cards .tile.card-system-info .card-reveal .card-title {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 25px
        }

        #tab-intro .tab-intro-cards .tile.card-system-info .card-reveal .card-title i:hover {
            color: red
        }

        #tab-intro .tab-intro-cards .tile.card-system-info .card-reveal a:hover {
            color: #00f
        }

        #tab-intro .tab-intro-cards .tile.card-system-info .card-reveal a {
            position: absolute;
            top: 10px;
            right: 50px;
            color: #000;
            cursor: pointer
        }

        #tab-intro .tab-intro-cards .tile.card-system-info .card-reveal:hover {
            overflow-y: scroll;
            padding-right: 18px
        }

        #tab-intro .tab-intro-cards .tile.card-system-info .card-action {
            display: none
        }

        #tab-intro .tab-intro-cards .tile.card-system-info .system-warning {
            color: red;
            font-weight: 700
        }

        .nav-wrapper {
            padding-left: 20px;
        }

        body {
            font-family: "Segoe UI", Tahoma, Arial, "Courier New", sans-serif;
        }
    </style>
    <script>
        var $iframeDialog  = null;  // used in adapter settings window
        var configNotSaved = null;  // used in adapter settings window
        var showConfig     = null;  // used in adapter settings window
        var ignoreNotSaved = false;

        function initEvents() {
            $iframeDialog = {
                close: function () {ignoreNotSaved = true; window.location.hash = '';}
            };
            var eventFunc = window.addEventListener ? 'addEventListener' : 'attachEvent';
            var emit = window[eventFunc];
            var eventName = eventFunc === 'attachEvent' ? 'onmessage' : 'message';

            // receive messages from IFRAME
            emit(eventName, function (event) {
                console.log(event.data);
                if (event.data === 'close' || event.message === 'close') {
                    ignoreNotSaved = true;
                    window.location.hash = '';
                } else {
                    try {
                        window.showConfig = JSON.parse(event.data|| event.message);
                    } catch (e) {
                        console.log('Unknown event: ' + (event.data|| event.message));
                    }
                }
            }, false);
        }

        function getCard(options, isTab) {
            var $card = window.$template.clone();
            $card.removeAttr('id');
            $card.data('id', options.id);

            // link
            $card.find('.url')
                .text(options.id)
                //.attr('href', options.url)
                .data('name', options.id);

            $card.off('click').on('click', function (e) {
                e.preventDefault();
                e.stopPropagation();
                window.location.hash = '#' + $(this).data('id');
            });

            // icon
            $card.find('.card-image-img').attr('src', options.icon ? 'adapter/' + options.id.split('.')[0] + '/' + options.icon : 'img/no-image.png');
            options.color && $card.find('.card-image').css('background', options.color);

            // title
            var title = options.name;
            if (typeof title === 'object') {
                title = title[systemLang] || title.en;
            }
            $card.find('.card-titles').text(title);

            var desc = options.desc;
            if (typeof desc === 'object') {
                desc = desc[systemLang] || desc.en;
            }
            $card.find('.card-content-text').text(desc || '');
            return $card;
        }
    </script>
</head>
<body class="m">
<nav>
    <div class="nav-wrapper">
        <a id="back" style="font-size: 36px; padding-right: 10px; display: none; cursor: pointer">&#8592;</a>
        <span class="button-icon">
            <img style="background: white; border-radius: 100px; width: 48px; margin: 9px;" src="img/no-image.png">
        </span>
        <a class="brand-logo">Easy Admin</a>
        <ul id="admin" style="display: none" class="right hide-on-med-and-down">
            <li><a href="./index.html">Admin</a></li>
        </ul>
    </div>
</nav>
<div style="width: 100%; overflow: hidden; height: calc(100% - 64px)" id="tab-intro">
    <div class="tab-intro-cards row" style="width: 100%; overflow-x: hidden; overflow-y: auto; height: 100%">

    </div>
    <div style="height: 40px; background: #64b5f6; padding-left: 20px; font-size: 24px; color: white;" id="adapter_name"></div>
    <iframe id="config-iframe" name="config-iframe" src="" style="display: none; border: 0; width: 100%; overflow-x: hidden; overflow-y: auto; height: 100%"></iframe>
</div>

<div id="intro-template" class="col s12 m6 l4 xl3 xxl2 xxxl1 tile">
    <div class="card horizontal hoverable">
        <a class="btn-floating btn-large waves-effect waves-light blue btn-card-enabled"><i class="material-icons">check</i></a>
        <a class="info activator btn-small">INFO</a>
        <div class="card-image activator">
            <img class="card-image-img" src="">
        </div>
        <div class="card-stacked">
            <div class="card-content">
                <p><h5 class="card-titles"></h5><span class="card-content-text"></span></p>
            </div>
            <div class="card-action">
                <a href="#" class="url"></a>
            </div>
        </div>
        <div class="card-reveal">
            <span class="card-title grey-text text-darken-4">Info<i class="material-icons dp48">content_copy</i><i class="material-icons right">close</i></span>
        </div>
    </div>
</div>
<script>
    var config = '%%CONFIG%%';
    if (typeof config === 'string') {
        try {
            config = JSON.parse(config);
        } catch (e) {
            console.error('Cannot parse "' + config + '"');
            config = [];
        }
    }

    function showTiles() {
        window.$template = $('#intro-template');

        var $cards = [];
        for (var i = 0; i < config.length; i++) {
            config[i].tab && $cards.push(getCard(config[i], true));
            config[i].config && $cards.push(getCard(config[i], false));
        }
        var $tiles = $('.tab-intro-cards');
        $tiles.html('');
        for (var c = 0; c < $cards.length; c++) {
            $cards[c] && $tiles.append($cards[c]);
        }
        $tiles.show();
    }

    /*$(window).off('beforeunload').on('beforeunload', function (e) {
        try {
            if (!ignoreNotSaved && window.frames['config-iframe'].changed) {
                return 'Discard changes?';
            } else {
                return null;
            }
        } catch (e) {
            return null;
        }
    });*/

    function navigate() {
        // ignore if hash not changed
        if (window.location.hash === window.currentHash) {
            return;
        }
        try {
            if (!ignoreNotSaved && window.frames['config-iframe'].changed) {
                if (!window.confirm('Discard changes?')) {
                    history.replaceState(null, null, window.currentHash);
                    return;
                }
            }
            window.frames['config-iframe'].changed = false;
        } catch (e) {

        }

        ignoreNotSaved = false;

        window.currentHash = window.location.hash;

        var id = (window.location.hash || '').replace(/^#/, '');
        var a = id && config.find(c => c.id === id);
        var $iframe = $('#config-iframe');
        if (a) {
            $('.tab-intro-cards').hide();
            if (a.tab) {
                $('#back').show();
                $('.button-icon').hide();
                $('.brand-logo').css('cursor', 'pointer').on('click', function () {window.location.hash = '';});
            } else {
                $('#back').hide();
                $('.button-icon').show();
                $('.brand-logo').css('cursor', 'default').off('click');
            }

            $('#adapter_name').show().html(a.title);
            $iframe.show();
            $iframe[0].contentWindow.location.replace(a.url);
        } else {
            $iframe.hide();
            $iframe[0].contentWindow.location.replace('./empty.html');

            $('#adapter_name').hide();
            $('.button-icon').show();
            $('#back').hide();
            $('.brand-logo').css('cursor', 'default').off('click');
            showTiles();
        }
    }

    $(document).ready(function () {
        initEvents();
        window.addEventListener('hashchange', navigate, false);
        $('#back').on('click', function () {window.location.hash = '';});

        if (window.location.href.indexOf('/configs.html') !== -1) {
            $('#admin').show();
        }

        window.currentHash = null;
        navigate();
    });
</script>
</body>
</html>